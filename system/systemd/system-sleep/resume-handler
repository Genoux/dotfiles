#!/usr/bin/env bash
# System resume handler
# Restores network and user session state after suspend/hibernate

case "$1/$2" in
  pre/*)
    # Nothing needed before suspend
    ;;

  post/*)
    # After resume - restore system and user state

    # Restart NetworkManager (non-blocking)
    systemctl restart NetworkManager &

    # Give NetworkManager time to initialize
    sleep 2

    # Restart user services for each user
    for user_dir in /run/user/*; do
      [ -d "$user_dir" ] || continue
      uid=$(basename "$user_dir")
      user_name=$(id -nu "$uid" 2>/dev/null) || continue

      logger -t resume-handler "Restarting services for user $user_name"

      # Restart AGS (wait for monitors to be ready)
      systemd-run --user --machine="$user_name@.host" /bin/bash -c '
        for i in {1..20}; do
          if hyprctl monitors -j 2>/dev/null | grep -q "id"; then
            systemctl --user restart ags.service
            exit 0
          fi
          sleep 0.5
        done
        systemctl --user restart ags.service
      ' &

      # Reconnect Bluetooth devices
      systemd-run --user --machine="$user_name@.host" systemctl --user restart bluetooth.service &
    done
    ;;
esac
