#!/usr/bin/env bash
# Reconnect trusted Bluetooth devices on login
# Automatically finds and reconnects all trusted devices that aren't connected

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if bluetoothctl is available
if ! command -v bluetoothctl >/dev/null 2>&1; then
    log_error "bluetoothctl not found. Please install bluez-utils."
    exit 1
fi

log_info "Starting Bluetooth device reconnection..."

# Wait for Bluetooth to be ready and responsive (max 10 seconds)
log_info "Waiting for Bluetooth adapter to be ready..."
for i in {1..20}; do
    if bluetoothctl show 2>/dev/null | grep -q "Powered: yes"; then
        # Test if bluetoothctl is actually responsive by trying to list devices
        if bluetoothctl devices >/dev/null 2>&1; then
            log_info "Bluetooth adapter is ready and responsive"
            break
        fi
    fi
    if [ $i -eq 20 ]; then
        log_error "Bluetooth adapter not ready after 10 seconds"
        exit 1
    fi
    sleep 0.5
done

# Get all paired devices
devices_found=0
devices_reconnected=0

while IFS= read -r line; do
    if [ -z "$line" ]; then
        continue
    fi
    
    mac=$(echo "$line" | awk '{print $2}')
    name=$(echo "$line" | awk '{for(i=3;i<=NF;i++) printf "%s ", $i; print ""}' | sed 's/ $//')
    
    if [ -z "$mac" ]; then
        continue
    fi
    
    devices_found=$((devices_found + 1))
    
    # Check if device is trusted
    if bluetoothctl info "$mac" 2>/dev/null | grep -q "Trusted: yes"; then
        # Check if already connected
        if ! bluetoothctl info "$mac" 2>/dev/null | grep -q "Connected: yes"; then
            # Check if it's an audio device (has audio-related UUIDs)
            device_info=$(bluetoothctl info "$mac" 2>/dev/null)
            is_audio_device=false
            
            if echo "$device_info" | grep -q "Audio Sink\|Audio Source\|Headset\|Handsfree\|A2DP\|HFP"; then
                is_audio_device=true
            fi
            
            log_info "Attempting to reconnect: $name ($mac) [Audio: $is_audio_device]"
            
            # For audio devices, use faster connection method
            if [ "$is_audio_device" = true ]; then
                log_info "Fast reconnection for audio device: $name"
                if timeout 5 bluetoothctl connect "$mac" >/dev/null 2>&1; then
                    log_info "Successfully reconnected: $name"
                    devices_reconnected=$((devices_reconnected + 1))
                else
                    log_warn "Failed to reconnect: $name"
                fi
            else
                # For non-audio devices, use standard method
                if timeout 10 bluetoothctl connect "$mac" >/dev/null 2>&1; then
                    log_info "Successfully reconnected: $name"
                    devices_reconnected=$((devices_reconnected + 1))
                else
                    log_warn "Failed to reconnect: $name"
                fi
            fi
        else
            log_info "Already connected: $name"
        fi
    else
        log_info "Skipping untrusted device: $name"
    fi
done < <(bluetoothctl devices 2>/dev/null)

if [ $devices_found -eq 0 ]; then
    log_warn "No paired devices found"
else
    log_info "Found $devices_found paired devices, reconnected $devices_reconnected"
fi

log_info "Bluetooth reconnection completed"
