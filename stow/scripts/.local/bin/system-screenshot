#!/bin/bash

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${SCREENSHOT_DIR:-${XDG_PICTURES_DIR:-$HOME/Pictures}}"
FILENAME="$OUTPUT_DIR/screenshot-$(date +'%Y-%m-%d_%H-%M-%S').png"

# Trim geometry to ensure it fits within monitor bounds
trim_geometry() {
    local geometry="${1}"
    local xy_str=$(echo "${geometry}" | cut -d' ' -f1)
    local wh_str=$(echo "${geometry}" | cut -d' ' -f2)
    local x=$(echo "${xy_str}" | cut -d',' -f1)
    local y=$(echo "${xy_str}" | cut -d',' -f2)
    local width=$(echo "${wh_str}" | cut -dx -f1)
    local height=$(echo "${wh_str}" | cut -dx -f2)

    # Get monitor bounds (accounting for rotation/transform)
    local max_width=$(hyprctl monitors -j | jq -r '[.[] | if (.transform % 2 == 0) then (.x + .width) else (.x + .height) end] | max')
    local max_height=$(hyprctl monitors -j | jq -r '[.[] | if (.transform % 2 == 0) then (.y + .height) else (.y + .width) end] | max')
    local min_x=$(hyprctl monitors -j | jq -r '[.[] | (.x)] | min')
    local min_y=$(hyprctl monitors -j | jq -r '[.[] | (.y)] | min')

    local cropped_x=$x
    local cropped_y=$y
    local cropped_width=$width
    local cropped_height=$height

    # Crop if window extends beyond right/bottom edges
    if ((x + width > max_width)); then
        cropped_width=$((max_width - x))
    fi
    if ((y + height > max_height)); then
        cropped_height=$((max_height - y))
    fi

    # Adjust if window extends beyond left/top edges
    if ((x < min_x)); then
        cropped_x=$min_x
        cropped_width=$((cropped_width + x - min_x))
    fi
    if ((y < min_y)); then
        cropped_y=$min_y
        cropped_height=$((cropped_height + y - min_y))
    fi

    # Ensure dimensions are positive
    if ((cropped_width <= 0 || cropped_height <= 0)); then
        return 1
    fi

    printf "%s,%s %sx%s" "${cropped_x}" "${cropped_y}" "${cropped_width}" "${cropped_height}"
}

case "${1:-region}" in
  output)
    MODE="output"
    ;;
  window)
    MODE="window"
    ;;
  *)
    MODE="region"
    ;;
esac


case "$MODE" in
    window)
        # Get active window geometry
        active_window=$(hyprctl activewindow -j)
        x=$(echo "$active_window" | jq -r '.at[0]')
        y=$(echo "$active_window" | jq -r '.at[1]')
        w=$(echo "$active_window" | jq -r '.size[0]')
        h=$(echo "$active_window" | jq -r '.size[1]')
        geometry="$x,$y ${w}x$h"

        trimmed_geometry=$(trim_geometry "$geometry")
        if [[ -n "$trimmed_geometry" ]]; then
            grim -g "$trimmed_geometry" - | satty --filename - --output-filename "$FILENAME"
        else
            echo "Error: No active window" >&2
            exit 1
        fi
        ;;

    region)
        geometry=$(slurp)

        if [[ -n "$geometry" ]]; then
            sleep 0.1
            grim -g "$geometry" - | satty --filename - --output-filename "$FILENAME"
        else
            exit 1
        fi
        ;;

    output)
        # Get focused monitor geometry
        monitor=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true)')
        x=$(echo "$monitor" | jq -r '.x')
        y=$(echo "$monitor" | jq -r '.y')
        w=$(echo "$monitor" | jq -r '.width')
        h=$(echo "$monitor" | jq -r '.height')

        grim -g "${x},${y} ${w}x${h}" - | satty --filename - --output-filename "$FILENAME"
        ;;
esac
