#!/bin/bash
# Update dotfiles repository from remote
# Pulls changes from origin/main and restarts services

set -euo pipefail

# Configuration
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
STATE_DIR="$HOME/.local/state/dotfiles"
STATE_FILE="$STATE_DIR/updates.state"

# Check if gum is available for confirmation
if ! command -v gum &>/dev/null; then
    echo "Error: gum is required for confirmation dialogs" >&2
    exit 1
fi

# Check if we're in a git repository
if [[ ! -d "$DOTFILES_DIR/.git" ]]; then
    echo "Error: $DOTFILES_DIR is not a git repository" >&2
    notify-send --app-name="Dotfiles" --icon="dialog-error" --urgency=critical \
        "Dotfiles Update Failed" "Not a git repository: $DOTFILES_DIR" 2>/dev/null || true
    exit 1
fi

cd "$DOTFILES_DIR" || exit 1

# Check if there are local uncommitted changes
if [[ -n $(git status --porcelain 2>/dev/null) ]]; then
    echo "âš ï¸  Warning: You have uncommitted changes in your dotfiles"
    echo ""
    git status --short
    echo ""
    
    if ! gum confirm "Continue with update? (local changes will be preserved)"; then
        exit 0
    fi
fi

# Fetch latest changes
echo "ðŸ”„ Fetching latest changes..."
if ! git fetch origin main 2>&1; then
    echo "âŒ Failed to fetch from remote"
    notify-send --app-name="Dotfiles" --icon="dialog-error" --urgency=critical \
        "Dotfiles Update Failed" "Could not fetch from remote repository" 2>/dev/null || true
    exit 1
fi

# Check if updates are available
LOCAL_COMMIT=$(git rev-parse HEAD 2>/dev/null)
REMOTE_COMMIT=$(git rev-parse origin/main 2>/dev/null)

if [[ "$LOCAL_COMMIT" == "$REMOTE_COMMIT" ]]; then
    echo "âœ… Already up to date"
    
    # Clear state file
    if [[ -f "$STATE_FILE" ]]; then
        cat > "$STATE_FILE" <<EOF
UPDATES_AVAILABLE=false
COMMIT_COUNT=0
LAST_CHECK=$(date +%s)
LOCAL_COMMIT=$LOCAL_COMMIT
REMOTE_COMMIT=$REMOTE_COMMIT
EOF
    fi
    
    exit 0
fi

# Show what will be updated
COMMIT_COUNT=$(git rev-list HEAD..origin/main --count 2>/dev/null || echo 0)
echo ""
echo "ðŸ“‹ Changes to be applied ($COMMIT_COUNT commit(s)):"
echo ""
git log HEAD..origin/main --oneline --color=always 2>/dev/null || true
echo ""

# Confirm update
if ! gum confirm "Pull these changes?"; then
    exit 0
fi

# Pull changes
echo ""
echo "â¬‡ï¸  Pulling changes..."
if ! git pull origin main 2>&1; then
    echo ""
    echo "âŒ Failed to pull changes"
    echo ""
    echo "This might be due to merge conflicts. You can resolve them manually by:"
    echo "  cd $DOTFILES_DIR"
    echo "  git status"
    echo "  # resolve conflicts"
    echo "  git pull origin main"
    
    notify-send --app-name="Dotfiles" --icon="dialog-error" --urgency=critical \
        "Dotfiles Update Failed" "Git pull failed - check for conflicts" 2>/dev/null || true
    exit 1
fi

echo "âœ… Successfully updated dotfiles"

# Clear state file
mkdir -p "$STATE_DIR"
cat > "$STATE_FILE" <<EOF
UPDATES_AVAILABLE=false
COMMIT_COUNT=0
LAST_CHECK=$(date +%s)
LOCAL_COMMIT=$REMOTE_COMMIT
REMOTE_COMMIT=$REMOTE_COMMIT
EOF

# Restart AGS service if running
echo ""
echo "ðŸ”„ Restarting services..."
if systemctl --user is-active --quiet ags.service; then
    systemctl --user restart ags.service 2>&1 || {
        echo "âš ï¸  Warning: Failed to restart AGS service"
    }
    echo "âœ… AGS service restarted"
else
    echo "â„¹ï¸  AGS service not running, skipping restart"
fi

# Success notification
notify-send --app-name="Dotfiles" --icon="system-software-update" --urgency=normal \
    "Dotfiles Updated" "Successfully pulled $COMMIT_COUNT commit(s) from remote" 2>/dev/null || true

echo ""
echo "ðŸŽ‰ Update complete!"

