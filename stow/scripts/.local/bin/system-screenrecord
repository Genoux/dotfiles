#!/bin/bash

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${SCREENRECORD_DIR:-${XDG_VIDEOS_DIR:-$HOME/Videos}}"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  notify-send "Screen recording directory does not exist: $OUTPUT_DIR" -u critical -t 3000
  exit 1
fi

# Selects region or output
SCOPE="$1"

# Selects audio inclusion or not
AUDIO=$([[ $2 == "audio" ]] && echo "--audio")

start_screenrecording() {
  local filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"

  if lspci | grep -qi 'nvidia'; then
    wf-recorder $AUDIO -f "$filename" -c libx264 -p crf=23 -p preset=medium -p movflags=+faststart "$@" &
  else
    wl-screenrec $AUDIO -f "$filename" --ffmpeg-encoder-options="-c:v libx264 -crf 23 -preset medium -movflags +faststart" "$@" &
  fi

  notify-send "Screen recording started" "Press the same keybind to stop" -t 2000
  toggle_screenrecording_indicator
}

stop_screenrecording() {
  pkill -x wl-screenrec
  pkill -x wf-recorder

  # Get the most recent recording file
  local latest_file=$(ls -t "$OUTPUT_DIR"/screenrecording-*.mp4 2>/dev/null | head -1)
  local filename=$(basename "$latest_file" 2>/dev/null || echo "screenrecording")

  if [[ -f "$latest_file" ]]; then
    # Send notification with actions
    notify-send "Screen recording saved" "Saved to: $filename" \
      -t 5000 \
      -a "Screen Recorder" \
      --action="default=Open Folder" \
      --action="open-video=Play Video" | while read -r action; do
        case "$action" in
          "default")
            xdg-open "$OUTPUT_DIR" &
            ;;
          "open-video")
            xdg-open "$latest_file" &
            ;;
        esac
      done &
  else
    notify-send "Screen recording saved" "Saved to: $filename" -t 3000
  fi

  sleep 0.2 # ensures the process is actually dead before we check
  toggle_screenrecording_indicator
}

toggle_screenrecording_indicator() {
  # Signal waybar if it exists, otherwise do nothing
  pkill -RTMIN+8 waybar 2>/dev/null || true
}

screenrecording_active() {
  pgrep -x wl-screenrec >/dev/null || pgrep -x wf-recorder >/dev/null
}

if screenrecording_active; then
  stop_screenrecording
elif [[ "$SCOPE" == "fullscreen" ]]; then
  # Record entire screen without selection
  start_screenrecording
elif [[ "$SCOPE" == "output" ]]; then
  # Select a specific display
  output=$(slurp -o) || exit 1
  start_screenrecording -g "$output"
else
  # Select a region
  region=$(slurp) || exit 1
  start_screenrecording -g "$region"
fi

