#!/bin/bash
# Dotfiles Daily Management CLI

# Get dotfiles directory (follow symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
export DOTFILES_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
export DOTFILES_INSTALL="$DOTFILES_DIR/install"

# Load helpers
source "$DOTFILES_DIR/install/helpers/all.sh"

# Initialize logging for daily operations
init_logging "daily"

# Ensure gum is available
ensure_gum

# Show usage
show_usage() {
    if command -v gum &>/dev/null; then
        gum style --bold "Dotfiles Manager"
        echo
        gum style --foreground 240 "Usage: dotfiles <command> [subcommand] [options]"
        echo
        echo "Commands:"
        echo
        echo -e "\e[38;5;14m  status\e[0m\e[38;5;240m               Show system state\e[0m"
        echo -e "\e[38;5;14m  install\e[0m\e[38;5;240m              Run full installation\e[0m"
        echo
        echo -e "\e[38;5;14m  packages\e[0m\e[38;5;240m             Manage packages\e[0m"
        echo "    manage                 Interactive package management (default)"
        echo "    update                 System update (yay -Syu)"
        echo "    status                 Show package info"
        echo
        echo -e "\e[38;5;14m  config\e[0m\e[38;5;240m               Manage configurations\e[0m"
        echo "    link [name]            Link configs (all or specific)"
        echo "    unlink [name]          Unlink configs"
        echo "    status                 Show link status"
        echo
        echo -e "\e[38;5;14m  system\e[0m\e[38;5;240m               System-level configurations\e[0m"
        echo "    apply                  Apply system configs"
        echo "    status                 Show system info"
        echo
        echo -e "\e[38;5;14m  theme\e[0m\e[38;5;240m                Manage theme\e[0m"
        echo "    apply                  Apply theme files"
        echo "    install-gtk            Install GTK theme"
        echo "    status                 Show theme info"
        echo
        echo -e "\e[38;5;14m  shell\e[0m\e[38;5;240m                Shell management\e[0m"
        echo "    setup                  Setup zsh + omz + plugins"
        echo "    status                 Show shell info"
        echo
        echo -e "\e[38;5;14m  hyprland\e[0m\e[38;5;240m             Hyprland configuration\e[0m"
        echo "    setup                  Setup plugins and monitors"
        echo "    status                 Show Hyprland info"
        echo
        echo -e "\e[38;5;14m  menu\e[0m\e[38;5;240m                 Show interactive menu\e[0m"
    else
        echo "Dotfiles Manager"
        echo ""
        echo "Usage: dotfiles <command> [subcommand] [options]"
        echo ""
        echo "Commands:"
        echo "  status                    Show system state"
        echo "  install                   Run full installation"
        echo ""
        echo "  packages                  Manage packages"
        echo "    manage                  Interactive package management (default)"
        echo "    update                  System update (yay -Syu)"
        echo "    status                  Show package info"
        echo ""
        echo "  config                    Manage configurations"
        echo "    link [name]             Link configs (all or specific)"
        echo "    unlink [name]           Unlink configs"
        echo "    status                  Show link status"
        echo ""
        echo "  system                    System-level configurations"
        echo "    apply                   Apply system configs"
        echo "    status                  Show system info"
        echo ""
        echo "  theme                     Manage theme"
        echo "    apply                   Apply theme files"
        echo "    install-gtk             Install GTK theme"
        echo "    status                  Show theme info"
        echo ""
        echo "  shell                     Shell management"
        echo "    setup                   Setup zsh + omz + plugins"
        echo "    status                  Show shell info"
        echo ""
        echo "  hyprland                  Hyprland configuration"
        echo "    setup                   Setup plugins and monitors"
        echo "    status                  Show Hyprland info"
        echo ""
        echo "  menu                      Show interactive menu"
    fi
}

# Show overall system status
show_status() {
    clear_screen "System Status"
    
    # Hardware info
    show_hardware_info
    
    # Package status
    source "$DOTFILES_DIR/lib/package.sh"
    packages_status
    echo
    
    # Config status
    source "$DOTFILES_DIR/lib/config.sh"
    config_status
    echo
    
    # Theme status
    source "$DOTFILES_DIR/lib/theme.sh"
    theme_status
    echo
    
    # Shell status
    source "$DOTFILES_DIR/lib/shell.sh"
    shell_status
    echo
    
    # Hyprland status
    source "$DOTFILES_DIR/lib/hyprland.sh"
    hyprland_status
}

# Interactive menu
show_menu() {
    while true; do
        clear
        if command -v gum &>/dev/null && [[ -f "$DOTFILES_DIR/system.txt" ]]; then
            gum style --foreground 212 < "$DOTFILES_DIR/system.txt"
            echo
        fi
        
        local action
        if command -v gum &>/dev/null; then
            action=$(gum choose --header "" --selected "System Status" \
                "System Status" \
                "Full Install" \
                "Packages" \
                "Configs" \
                "System" \
                "Themes" \
                "Shell" \
                "Hyprland" \
                "" \
                "Exit")
        else
            action=$(choose_option \
                "System Status" \
                "Full Install" \
                "Packages" \
                "Configs" \
                "System" \
                "Themes" \
                "Shell" \
                "Hyprland" \
                "" \
                "Exit")
        fi
        
        [[ -z "$action" ]] && exit 0  # ESC pressed
        
        case "$action" in
            "System Status")
                show_status
                echo
                read -p "Press Enter to continue..."
                ;;
            "Full Install")
                clear_screen
                bash "$DOTFILES_DIR/install.sh"
                ;;
            "Packages")
                menu_packages
                ;;
            "Configs")
                menu_configs
                ;;
            "System")
                menu_system
                ;;
            "Themes")
                menu_themes
                ;;
            "Shell")
                menu_shell
                ;;
            "Hyprland")
                menu_hyprland
                ;;
            "Exit")
                clear
                log_success "Goodbye!"
                exit 0
                ;;
            "")
                continue
                ;;
        esac
    done
}

# Package management menu
menu_packages() {
    while true; do
        clear_screen "Packages"
        
        # Show current package count
        source "$DOTFILES_DIR/lib/package.sh"
        local pkg_count=$(grep -cvE '^#|^$' "$DOTFILES_DIR/packages.txt" 2>/dev/null || echo 0)
        local aur_count=$(grep -cvE '^#|^$' "$DOTFILES_DIR/aur-packages.txt" 2>/dev/null || echo 0)
        show_info "Tracked" "$pkg_count official + $aur_count AUR"
        echo
        
        local action=$(choose_option \
            "Install all from dotfiles" \
            "Manage packages" \
            "Update system" \
            "Show status" \
            "Back")

        [[ -z "$action" ]] && return  # ESC pressed

        case "$action" in
            "Install all from dotfiles")
                clear_screen
                if packages_install; then
                    echo
                    read -p "Press Enter to continue..."
                fi
                ;;
            "Manage packages")
                clear_screen
                if packages_manage; then
                    echo
                    read -p "Press Enter to continue..."
                fi
                ;;
            "Update system")
                clear_screen
                if packages_update; then
                    echo
                    read -p "Press Enter to continue..."
                else
                    echo
                    log_error "Update failed. Showing recent log output:"
                    echo
                    if [[ -n "${DOTFILES_LOG_FILE:-}" && -f "$DOTFILES_LOG_FILE" ]]; then
                        tail -n 120 "$DOTFILES_LOG_FILE"
                    else
                        echo "No log file available. Rerun: dotfiles packages update 2>&1 | tee /tmp/dotfiles-update.log"
                    fi
                    echo
                    read -p "Press Enter to continue..."
                fi
                ;;
            "Show status")
                clear_screen
                if packages_status; then
                    echo
                    read -p "Press Enter to continue..."
                fi
                ;;
            "Back")
                return
                ;;
        esac
    done
}

# Config management menu
menu_configs() {
    while true; do
        clear_screen "Configs"

        source "$DOTFILES_DIR/lib/config.sh"

        # Show summary only
        local configs=($(get_configs))
        local linked_count=0
        for config in "${configs[@]}"; do
            is_config_linked "$config" && ((linked_count++))
        done
        show_info "Status" "$linked_count/${#configs[@]} linked"
        echo

        local action=$(choose_option \
            "Manage links" \
            "Link all" \
            "Unlink all" \
            "Show details" \
            "Back")

        [[ -z "$action" ]] && return  # ESC pressed

        case "$action" in
            "Manage links")
                clear_screen
                config_manage_interactive
                echo
                read -p "Press Enter to continue..."
                ;;
            "Link all")
                clear_screen
                config_link_all
                echo
                read -p "Press Enter to continue..."
                ;;
            "Unlink all")
                clear_screen
                if confirm "Unlink all configs?"; then
                    config_unlink_all
                fi
                echo
                read -p "Press Enter to continue..."
                ;;
            "Show details")
                clear_screen
                config_status
                echo
                read -p "Press Enter to continue..."
                ;;
            "Back")
                return
                ;;
        esac
    done
}

# Theme management menu
menu_themes() {
    while true; do
        clear_screen "Themes"
        
        source "$DOTFILES_DIR/lib/theme.sh"
        
        # Show quick status
        local theme_dir="$DOTFILES_DIR/themes/default"
        local theme_files=$(ls "$theme_dir" 2>/dev/null | wc -l)
        show_info "Active theme" "default ($theme_files files)"
        echo
        
        local action=$(choose_option \
            "Apply theme" \
            "Install GTK theme" \
            "Show details" \
            "Back")
        
        [[ -z "$action" ]] && return  # ESC pressed
        
        case "$action" in
            "Apply theme")
                clear_screen
                theme_apply
                echo
                read -p "Press Enter to continue..."
                ;;
            "Install GTK theme")
                clear_screen
                theme_install_gtk
                echo
                read -p "Press Enter to continue..."
                ;;
            "Show details")
                clear_screen
                theme_status
                echo
                read -p "Press Enter to continue..."
                ;;
            "Back")
                return
                ;;
        esac
    done
}

# System management menu
menu_system() {
    while true; do
        clear_screen "System"

        source "$DOTFILES_DIR/lib/system.sh"

        local action=$(choose_option \
            "Apply configurations" \
            "Back")

        [[ -z "$action" ]] && return  # ESC pressed

        case "$action" in
            "Apply configurations")
                clear_screen
                if system_apply; then
                    echo
                    read -p "Press Enter to continue..."
                fi
                ;;
            "Back")
                return
                ;;
        esac
    done
}

# Shell management menu
menu_shell() {
    while true; do
        clear_screen "Shell"

        source "$DOTFILES_DIR/lib/shell.sh"

        # Show quick status
        if command -v zsh &>/dev/null; then
            local version=$(zsh --version | cut -d' ' -f2)
            show_info "Version" "$version"
        else
            show_info "Status" "not installed"
        fi
        echo

        local action=$(choose_option \
            "Setup shell" \
            "Show details" \
            "Back")

        [[ -z "$action" ]] && return  # ESC pressed

        case "$action" in
            "Setup shell")
                clear_screen
                shell_setup
                echo
                read -p "Press Enter to continue..."
                ;;
            "Show details")
                clear_screen
                shell_status
                echo
                read -p "Press Enter to continue..."
                ;;
            "Back")
                return
                ;;
        esac
    done
}

# Hyprland management menu
menu_hyprland() {
    while true; do
        clear_screen "Hyprland"

        source "$DOTFILES_DIR/lib/hyprland.sh"

        # Show quick status
        if command -v hyprctl &>/dev/null; then
            local version=$(hyprctl version 2>/dev/null | head -1 | grep -oP 'Hyprland \K\d+\.\d+\.\d+' || echo "unknown")
            show_info "Version" "$version"
        else
            show_info "Status" "not installed"
        fi
        echo

        local action=$(choose_option \
            "Setup Hyprland" \
            "Show details" \
            "Back")

        [[ -z "$action" ]] && return  # ESC pressed

        case "$action" in
            "Setup Hyprland")
                clear_screen

                # Setup plugins using our improved library function
                if command -v hyprpm &>/dev/null; then
                    source "$DOTFILES_DIR/lib/hyprland-plugins.sh"
                    setup_hyprland_plugins
                    echo
                fi

                # Setup monitors
                hyprland_setup
                echo
                read -p "Press Enter to continue..."
                ;;
            "Show details")
                clear_screen
                hyprland_status
                echo
                read -p "Press Enter to continue..."
                ;;
            "Back")
                return
                ;;
        esac
    done
}

# Main command routing
main() {
    local command="${1:-menu}"
    local subcommand="${2:-}"
    local arg3="${3:-}"
    
    case "$command" in
        status)
            show_status
            ;;
        install)
            bash "$DOTFILES_DIR/install.sh"
            ;;
        packages|pkg)
            source "$DOTFILES_DIR/lib/package.sh"
            case "$subcommand" in
                manage|"") packages_manage ;;
                update) packages_update || exit $? ;;
                status) packages_status ;;
                # Legacy commands still work
                install) packages_install || exit $? ;;
                sync) packages_sync || exit $? ;;
                clean) packages_clean_unlisted || exit $? ;;
                *) log_error "Unknown subcommand: $subcommand"; show_usage; exit 1 ;;
            esac
            ;;
        config|cfg)
            source "$DOTFILES_DIR/lib/config.sh"
            case "$subcommand" in
                link) 
                    if [[ -n "$arg3" ]]; then
                        config_link "$arg3"
                    else
                        config_link_all
                    fi
                    ;;
                unlink)
                    if [[ -n "$arg3" ]]; then
                        config_unlink "$arg3"
                    else
                        config_unlink_all
                    fi
                    ;;
                status|"") config_status ;;
                *) log_error "Unknown subcommand: $subcommand"; show_usage; exit 1 ;;
            esac
            ;;
        system)
            source "$DOTFILES_DIR/lib/system.sh"
            case "$subcommand" in
                apply) system_apply ;;
                status|"") system_status ;;
                *) log_error "Unknown subcommand: $subcommand"; show_usage; exit 1 ;;
            esac
            ;;
        theme)
            source "$DOTFILES_DIR/lib/theme.sh"
            case "$subcommand" in
                apply) theme_apply ;;
                install-gtk) theme_install_gtk ;;
                status|"") theme_status ;;
                *) log_error "Unknown subcommand: $subcommand"; show_usage; exit 1 ;;
            esac
            ;;
        shell)
            source "$DOTFILES_DIR/lib/shell.sh"
            case "$subcommand" in
                setup) shell_setup ;;
                status|"") shell_status ;;
                *) log_error "Unknown subcommand: $subcommand"; show_usage; exit 1 ;;
            esac
            ;;
        hyprland)
            source "$DOTFILES_DIR/lib/hyprland.sh"
            case "$subcommand" in
                setup)
                    # Setup plugins and monitors
                    if command -v hyprpm &>/dev/null; then
                        source "$DOTFILES_DIR/lib/hyprland-plugins.sh"
                        setup_hyprland_plugins
                        echo
                    fi
                    hyprland_setup
                    ;;
                status|"") hyprland_status ;;
                *) log_error "Unknown subcommand: $subcommand"; show_usage; exit 1 ;;
            esac
            ;;
        menu)
            show_menu
            ;;
        help|--help|-h|"")
            show_usage
            ;;
        *)
            log_error "Unknown command: $command"
            show_usage
            exit 1
            ;;
    esac
    
    # Finish logging
    finish_logging
}

# Run main
main "$@"

